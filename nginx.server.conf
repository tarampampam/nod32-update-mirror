# Virtual server configuration
server {
  listen      %ip%:%httpport%;
  server_name %host%;
  root        %hostdir%;
  index       index.html;
  autoindex   on;
  access_log  off;
  
  # Setting directory names
  set $webface     "webface";
  set $errorspages "errorspages";

  # Setting custom error pages
  error_page 401 /error401.html;
  error_page 403 /error403.html;
  error_page 404 /error404.html;
  error_page 500 /error500.html;
  error_page 502 /error502.html;
  error_page 503 /error503.html;
  location ~ "^/error([\d]{3}\.html)$" {
    try_files /$webface/$errorspages/$1 $uri =404;
  }
  
  # Deny access for spiders/robots/tools/etc
  if ($http_user_agent ~* ^(wget|aria2|nod32view|perl|php|curl|google|yandex|yahoo|-|mirror|spider|bot|parser|grab)) {
    return 403;
  }

  # Deny direct access for hidden files/directories
  location ~ /\. {
    return 444;
  }
  
  # Redirect request to correct update.ver file, based on nod32 user-agent version
  location ~* "^(?<file_url>/update\.ver)$" {
    if ($http_user_agent ~* "BPC (?<version>[\d]{1,2})\.") {
      set $new_location "v$version$file_url";
    }
    if (-f $document_root/$new_location) {
      return 301 $scheme://$server_name/$new_location;
    }
  }
  
  # Enable checking username/password for updates files access
  location ~* ^.+\.nup$ {
    allow all;
    auth_basic "Enter login:password for getting access";
    auth_basic_user_file $document_root/.htpasswd;
  }
  
  # Redirect empty requests to webface index file
  location = / {
    try_files /$webface/index.html =404;
  }
  
  try_files $uri /$webface$uri /$webface/$errorspages$uri =404;
}